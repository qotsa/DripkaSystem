#**smev3client**
## Description
Camel based http-to-soap adapter. Java - based + mixed config (*resources/config*)
Contains:
- embedded Tomcat for using servlet transport in Camel
- [joolokia][0] servlet for using [Hawtio] [1]
- actuator metrics
- yaml based config
- spring profiles
- autowired props
- new test runner
- tested @adviceWith and @MockEndpoints

##Project structure
- archetype - maven archetype for new services
- dockercompose - contains docker-compose.yml template. As a result of build, docker-compose.yml in project root folder is created
- env - directory with environment configurations
- infra - infrastructure services (service discovery, configuration etc)
- infra/static - 3rd-party infrastructure services (ActiveMQ, ftp, databases, ELK etc)
- sh - a few awesome shell scripts
- smev3client - business services

##How to build
Maven profiles:
- debug - adds jvm debug flags to entrypoin in docker image
- docker-images-01-remove - use in activation mode, remove old images
- docker-images-02-build - use in activation mode, builds images
- docker-images-03-push - use in activation mode, push images
- env-xxx - uses filtering from env/xxx.properties for docker images and configuration files filtering
- integration-tests - enable integration testing during build
- skip-unit-tests - disable unit testing during build

Use "verify" goal to build correctly ("package" is not enough).

##How to run

There are main compose file in root project and compose files per each project, having only current service and 
its dependencies

Use spring boot plugin to run each service independently.
Use 
```
docker-compose up -d 
```
to run all the stuff.
All the images should be available for current docker daemon

##How to run hawtio console
Download executable jar from [Hawtio] [1] , start it and connect to jolokia agent using recomendations in welcome page.
Not forget to notice host/host managment port in spring config

##How to build docker image
Set env vars for remote/local building
E.g. 
```
DOCKER_TLS_VERIFY="1"
DOCKER_HOST="tcp://192.168.99.101:2376"
DOCKER_CERT_PATH="C:\Users\tartanov.mikhail\.docker\machine\machines\default"
DOCKER_MACHINE_NAME="default"
```
then build image using appropriate maven plugin

##How to debug
Use debug profile to build service for debugging

##TODO
- issues with one command build in maven
- unit and route tests
- all the microservices stuff : curcuit bracer, balancer, service discovery etc

###Known issues with docker
- Unable to build image on swarm cluster using this plugin. Should use local repo for checking out pre build images when starting services on cluster.

[0] : https://jolokia.org
[1] : http://hawt.io/

## TESTING & CODE COVERAGE REPORTS

The following properties affects the testing process:
skip.integration.tests - true by default, used to disable maven failsafe plugin
skip.unit.tests - false by default, used to disable maven surefire plugin

So by default, only unit testing is performed, and integration testing is skipped.
To disable unit testing, profile "skip-unit-tests" should be activated.
To enable integration testing, profile "integration-test" should be activated.

Code coverage reports are generated by jacoco maven plugin and located in the following directories:
target\site\jacoco-ut - code coverage report for unit tests
target\site\jacoco-it - code coverage report for integration tests

TODO coverage metrics should be used as constraints for build process (prevent build if coverage is lesser than required)

## Maven Archetype

For new modules in this project, a maven  archetype can be used for initial project setup.
Archetype itself is defined in module "archetype".

Example: creating a module "qwerty":
1. File/New/Module...
2. select Maven, Create from archetype: ru.otr.integration.smev3client:smev3client-archetype
   If archetype is not in the list, then use button "Add Archetype" to add it
3. Next
4. GroupId: Inherited, Version: inherited, ArtifactId: qwerty
5. Next
6. Add property "package=ru.otr.integration.smev3client.qwerty"
7. Next
8. Module name: qwerty
9. Finish
10. adjust generated module resources, replace "???" with correct values

## LBSS (https://github.com/gimatdinov/lbss)

deploy: docker-compose -p smev3client up -d

## Project versioning

1. all submodules does inherit version from parent
2. parent version should be in range [1.0.0,99.0.0) and consists of the following parts:
  major number - set in <version> tag, currently 1 followed by minor number ${revision}
  minor number - set in <revision> tag, currently 0.0
3. revision number - git revision, detected automatically and stored in parameters ${buildNumber} + ${buildDate}
4. docker images version is set in another property: <docker.images.version>

## Static IP for docker host machine (for boot2docker version running in virtualbox)

docker-machine ssh default
sudo tee /var/lib/boot2docker/bootsync.sh > /dev/null
kill `more /var/run/udhcpc.eth1.pid`
ifconfig eth1 192.168.99.99 netmask 255.255.255.0 broadcast 192.168.99.255 up
Ctrl+C
docker-machine regenerate-certs default

These commands will create script bootsync.sh in docker virtual machine, which is executed just before docker daemon.
Script will set IP address to 192.168.99.99 (because virtualbox dhcp starts with 192.168.99.100).
Docker machine should be restarted to apply changes.